// Generated by CoffeeScript 1.10.0
(function () {
  var Lib, Net, Should, Stream, OS;

  Should = require('should');

  OS = require('os');

  Stream = require('stream');

  Net = require('net');

  Lib = require('../lib');

  describe('keep-alive probes', function () {
    it('should be a function', function () {
      return Lib.setKeepAliveProbes.should.be.type('function');
    });
    it('should require two arguments', function () {
      var errorMessage;
      errorMessage = 'setKeepAliveProbes requires two arguments';
      (function () {
        return Lib.setKeepAliveProbes();
      }).should["throw"](errorMessage);
      (function () {
        return Lib.setKeepAliveProbes('');
      }).should["throw"](errorMessage);
      return (function () {
        return Lib.setKeepAliveProbes('', '', '');
      }).should["throw"](errorMessage);
    });
    it('should require first argument to be an instance of net.Socket', function () {
      var errorMessage;
      errorMessage = 'setKeepAliveProbes expects an instance of socket as its first argument';
      (function () {
        var socket;
        socket = null;
        return Lib.setKeepAliveProbes(socket, 1);
      }).should["throw"](errorMessage);
      (function () {
        var socket;
        socket = {};
        return Lib.setKeepAliveProbes(socket, 1);
      }).should["throw"](errorMessage);
      (function () {
        var socket;
        socket = new (function () {
        });
        return Lib.setKeepAliveProbes(socket, 1);
      }).should["throw"](errorMessage);
      return (function () {
        var socket;
        socket = new Stream.PassThrough;
        return Lib.setKeepAliveProbes(socket, 1);
      }).should["throw"](errorMessage);
    });
    it('should require second argument to be a number', function () {
      var errorMessage, socket;
      errorMessage = 'setKeepAliveProbes requires cnt to be a Number';
      socket = new Net.Socket;
      (function () {
        return Lib.setKeepAliveProbes(socket, null);
      }).should["throw"](errorMessage);
      (function () {
        return Lib.setKeepAliveProbes(socket, '');
      }).should["throw"](errorMessage);
      (function () {
        return Lib.setKeepAliveProbes(socket, true);
      }).should["throw"](errorMessage);
      return (function () {
        return Lib.setKeepAliveProbes(socket, {});
      }).should["throw"](errorMessage);
    });
    it('should throw when fd is missing', function () {
      var errorMessage, socket;
      errorMessage = 'Unable to get socket fd';
      socket = new Net.Socket;
      return (function () {
        return Lib.setKeepAliveProbes(socket, 1);
      }).should["throw"](errorMessage);
    });

    (['darwin', 'freebsd'].indexOf(OS.platform()) !== -1 ? it.skip : it)('should throw when setsockopt returns -1', function (done) {
      var errorMessage, socket;
      errorMessage = /^setsockopt /i;
      socket = null;
      return Net.createServer().listen(0, function () {
        var addr, self;
        addr = this.address();
        self = this;
        return socket = Net.createConnection(addr, function () {
          (function () {
            return Lib.setKeepAliveProbes(socket, -1);
          }).should["throw"](errorMessage);
          socket.destroy();
          self.close();
          return done();
        });
      });
    });

    it('should be able to set 1 probe threshold', function (done) {
      var socket;
      socket = null;
      return Net.createServer().listen(0, function () {
        var addr, self;
        addr = this.address();
        self = this;
        return socket = Net.createConnection(addr, function () {
          (function () {
            return Lib.setKeepAliveProbes(socket, 1);
          }).should.not["throw"]();
          socket.destroy();
          self.close();
          return done();
        });
      });
    });

    it('should be able to set and get 7 probe threshold', function (done) {
      var socket;
      socket = null;
      return Net.createServer().listen(0, function () {
        var addr, self, cnt = 7, readValue = null;
        addr = this.address();
        self = this;
        return socket = Net.createConnection(addr, function () {
          (function () {
            return Lib.setKeepAliveProbes(socket, cnt);
          }).should.not["throw"]();

          (function () {
            readValue = Lib.getKeepAliveProbes(socket);
          }).should.not["throw"]();

          readValue.should.eql(cnt)

          socket.destroy();
          self.close();
          return done();
        });
      });
    });

    it('should throw when trying to get using invalid fd', function (done) {
      var socket;
      socket = null;
      return Net.createServer().listen(0, function () {
        var addr, self;
        addr = this.address();
        self = this;
        return socket = Net.createConnection(addr, function () {

          var oldHandle = socket._handle
          socket._handle = {fd: -99999}

          ;(function () {
            Lib.getKeepAliveProbes(socket);
          }).should["throw"]('getsockopt EBADF');

          socket._handle = oldHandle

          socket.destroy();
          self.close();
          return done();
        });
      });
    });
  });

}).call(this);
